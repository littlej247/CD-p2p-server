<!DOCTYPE html>
<html>
<head>
   <title>cSecure</title>
</head>
<body>
    <label>Connection Token </label> <input id='token' style="width:300px;" /><br>
    <input type="button" id ='startScriptBtn' value="Start script"/><br>
<div style="display:none">
    <input id='message' style="width:300px;" /> <input type="button" id="sendMessage" value="Send message"/><br>

    <p>
    <input type="button" id ='upgrade' value="Go Peer 2 Peer"/><br>
    <textarea id="textarea" rows="10" cols="50"> </textarea>
</div>

<script src="https://ide.cumberlandapartments.ca/js/socket.io.min.js"></script>
<script src="https://ide.cumberlandapartments.ca/js/socketiop2p.min.js"></script>
<script> 

var msgBox = document.getElementById('message');
msgBox.value = getRandomTitle();
var tokenBox = document.getElementById('token');
var goPrivateBtn = document.getElementById('upgrade');    
goPrivateBtn.disabled = true;
var startBtn = document.getElementById('startScriptBtn');
startBtn.onclick =  ()=>{startScript()};
var textArea = document.getElementById('textarea');


function startScript(){
    tokenBox.disabled = true;
    startBtn.style.display="none";
    document.querySelector('div').style.display="unset";

    //window.manager = new io.Manager({ transports: ['websocket'] });
    var Opts = {
        peerOpts: {
            trickle:    true
        },
        autoUpgrade: false
    }

    //window.socket = manager.socket('/controllerData');
    window.socket = io('/controllerData');
    
    //var socket = new io('/controllerData');
    window.p2psocket = new P2P(socket, Opts, ()=>{
        goPrivateBtn.disabled = false;
        console.log('We all speak WebRTC now');
    });
    //console.log('Your user id is: ', socket.on().id);

    if (tokenBox.value == ""){
        p2psocket.emit("createRoom");
    } else {
        p2psocket.emit("joinRoom",tokenBox.value);
    }

    p2psocket.on('roomName', function (roomName) {
        tokenBox.value = roomName;
        console.log('room key is: ' + roomName);
    })


    // this event will be triggered over the socket transport
    p2psocket.on('message', function (data) {
        console.log('message: ', data);
        textArea.value = "peer => " + data+"\n" + textArea.value;
    })


    socket.on('connection', (socket)=>{
        console.log("socket connection established", socket.id);
    })

    p2psocket.on('upgrade', function (data) {
        console.log('connection is now p2p Socket');
    })

    document.getElementById('sendMessage').onclick = ()=>{
        p2psocket.emit('message',msgBox.value);
        textArea.value = "me   => " + msgBox.value+"\n" + textArea.value;
        msgBox.value = getRandomTitle();
    }
    
    function goPrivate(){
        p2psocket.useSockets = false;
        goPrivateBtn.disabled = true;
        console.log('connection should be private');
    }
    p2psocket.on('goPrivate', ()=>{
        console.log('command received to goPrivate')
        goPrivate();
        
    });
    goPrivateBtn.onclick = ()=>{
        p2psocket.emit('goPrivate');
        goPrivate();
    }

}



    //Get a fun random title incase one isn't specified
    function getRandomTitle(){
          var myArray = ["Whoa...","But....But....","Hold on a sec..","O Geeze..","I don't know Rick..","My man!",
             "S-S-Samantha.","Puh rum pum pow!","dont mind those stare goblins","Oh, wow.","Awww, it's you guys!",
             "Wubbalubbadubdub!","Uh ohhhh! Somersoult jump!","GRASSSSS... tastes bad!","No jumping in the sewer.",
             "BURGERTIME!","Rubber baby buggy bumpers!","I turned myself into a PICKLE!","Heavens to Murgatroyd!",
             "Hey hey hey!","You blockhead!","That's all I can stands, I can't stands no more!","Beep Beep",
             "And now, here's something we hope you'll really like.","Excellent.","Wonder Twin powers activate!",
             "Scooby-Dooby-Doo!","Sufferin' succotash!","Ay, caramba!","By the power of Greyskull!","Good grief.","D'oh!",
             "What's up, doc?","Giggity","Mmmkay","Lambs to the cosmic slaughter!","Keep Summer... safe!"
          ];
          return (myArray[Math.floor(Math.random()*myArray.length)]);
    }
</script>
</body>
</html>